name: Slack Scheduled Post

on:
  schedule:
    - cron: "0 0 * * *"    # æ¯æ—¥ 0:00 (UTC) ã«å®Ÿè¡Œ â†’ JST 9:00
  workflow_dispatch:        # æ‰‹å‹•å®Ÿè¡Œã‚‚æ®‹ã™

jobs:
  post_to_slack:
    runs-on: ubuntu-latest
    steps:
      - name: Maybe send message to Slack every 80 days
        run: |
          # ğŸ”¸ ã“ã“ã‚’ã€Œã‚«ã‚¦ãƒ³ãƒˆé–‹å§‹æ—¥ã«ã—ãŸã„æ—¥ã€ã«æ›¸ãæ›ãˆã¦ãã ã•ã„
          # ä¾‹: ã“ã®æ—¥ã‚’ã€Œ0æ—¥ç›®ã€ã¨ã—ã¦ã€80, 160, 240...æ—¥ç›®ã«æŠ•ç¨¿ã•ã‚Œã¾ã™
          START_DATE="2025-12-09"

          TODAY=$(date -u +"%Y-%m-%d")

          # æ—¥æ•°å·®ã‚’è¨ˆç®—ï¼ˆUbuntu ã® GNU date å‰æï¼‰
          days_since=$(( ( $(date -d "$TODAY" +%s) - $(date -d "$START_DATE" +%s) ) / 86400 ))

          echo "Days since START_DATE ($START_DATE): $days_since"

          # æœªæ¥æ—¥ã‚’ START_DATE ã«ã—ã¦ã—ã¾ã£ãŸå ´åˆã®ä¿é™º
          if [ "$days_since" -lt 0 ]; then
            echo "START_DATE is in the future. Skipping."
            exit 0
          fi

          # 80æ—¥ã”ã¨ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ä»¥å¤–ã¯ä½•ã‚‚ã—ãªã„ã§çµ‚äº†
          if [ $(( days_since % 80 )) -ne 0 ]; then
            echo "Not the 2th-day interval. Skipping send."
            exit 0
          fi

          # ã“ã“ã‹ã‚‰å®Ÿéš›ã«é€ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’çµ„ã¿ç«‹ã¦ã‚‹
          TEXT=$(cat <<'EOT'
!ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆã§ã™!
80æ—¥ã§ã®è‡ªå‹•æŠ•ç¨¿ã§ã™ã€‚
-------------
ã”å‚åŠ ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼
æ—¥ç¨‹èª¿æ•´ã‚„æ¬¡å›ã®æ—¥ä»˜ã€æ‰±ã†æ–‡çŒ®ç­‰ã¯ã€Œ#0-é‡è¦é€£çµ¡-æ—¥ç¨‹èª¿æ•´ ã€ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚
è‡ªå·±ç´¹ä»‹ã¯ã€ãªã‚‹ã¹ãã€Œ#1-è‡ªå·±ç´¹ä»‹ ã€ã¸ãŠé¡˜ã„ã—ã¾ã™ã€‚

Googleãƒ‰ãƒ©ã‚¤ãƒ–ï¼ˆå…±æœ‰ãƒ•ã‚©ãƒ«ãƒ€ï¼‰
å…±æœ‰ã¯ Google ãƒ•ã‚©ãƒ¼ãƒ ã«è¨˜å…¥ã•ã‚ŒãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã«æ‰‹å‹•ã§ä»˜ä¸ã—ã¦ã„ã¾ã™ã€‚ä¸‡ä¸€ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒãªã„å ´åˆã¯ã€Œã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’è¦æ±‚ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚asapã«å¯¾å¿œã—ã¾ã™ã€‚
URL: https://drive.google.com/drive/folders/18IyfnVQFcYf11FQJOvuOHWMVHm8_J618?usp=sharing
è‡ªèº«ã®ã‚µãƒ–ã‚¢ãƒ‰ãƒ¬ã‚¹ã®è¿½åŠ ã¯è‡ªç”±ã«OK

Zoom
https://u-tokyo-ac-jp.zoom.us/j/82926033122?pwd=ZUAtmUcFcia8amsyH7eRb1BqYKaVyZ.1

å…¬é–‹æ‹›å¾…ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
https://docs.google.com/document/d/1GqdoURxTjRty5qnrHfjv2wVUZ-8HH3fBY0NTVhc1Osk/edit?usp=sharing
ï¼ˆæ‹›å¾…æ–‡ãŒã“ã®ãƒãƒ£ãƒ³ãƒãƒ«ã®canvasã«ã‚ã‚Šã¾ã™ã€ã”è‡ªç”±ã«ãŠä½¿ã„ãã ã•ã„ã€‚ï¼‰

90æ—¥ä»¥å‰ã®è‡ªå·±ç´¹ä»‹å†…å®¹
ã“ã¡ã‚‰ ã¾ãŸã¯ ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­”

è³ªå•ã¯ #1-å®Ÿæ–½æ–¹å¼ã®ç›¸è«‡ã‚„ææ¡ˆ ã¸æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚
ã“ã®ãƒãƒ£ãƒ³ãƒãƒ«ã¯æ²ç¤ºæ¿æ‰±ã„ã®ãŸã‚æŠ•ç¨¿ã¯ä¸€æ—¦ç¦æ­¢ã§ã™ã€‚
EOT
)

          # jq ã§ JSON ã‚’å®‰å…¨ã«çµ„ã¿ç«‹ã¦ï¼ˆæ”¹è¡Œã‚‚ã„ã„æ„Ÿã˜ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚Œã‚‹ï¼‰
          jq -n --arg channel "${{ secrets.SLACK_CHANNEL_ID }}" --arg text "$TEXT" \
            '{channel: $channel, text: $text}' > payload.json

          curl -X POST "https://slack.com/api/chat.postMessage" \
            -H "Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}" \
            -H "Content-Type: application/json; charset=utf-8" \
            --data @payload.json
